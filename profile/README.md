# 🚀 Архитектура сервера GTA 5 на Alt:V с микросервисами и Docker

> **Alt:V — для мгновенной игровой логики. Docker-микросервисы — для всех внешних интеграций. Без лагов. С масштабируемостью. С надёжностью.**

Вы строите современный сервер GTA 5 на **Alt:V**, где **реальная игровая логика** (банки, такси, работа) остаётся в самом сервере — чтобы избежать любых задержек, лагов и нестабильности.  
Всё, что требует взаимодействия с внешним миром — **сайт, ланчер, Discord-бот, платежные системы, регистрация, статистика** — вынесено в **независимые микросервисы**, запущенные в **Docker** и доступные через единый **API-шлюз**.

Такой подход даёт:
- ✅ **Стабильность Alt:V** — его можно обновлять, перезапускать, менять — без риска сломать сайт или бота  
- ✅ **Централизованную базу данных** — PostgreSQL + Redis — общая “правда” для всего сервера  
- ✅ **Гибкую интеграцию** — сайт, лаунчер, Telegram — всё работает через один API  
- ✅ **Масштабируемость** — каждый сервис развивается независимо: можно увеличить количество сервисов донатов, не трогая такси  
- ✅ **Производительность** — кэширование, очереди, токены, мониторинг — всё на месте  

---

## 🔧 Основные компоненты

### 1. **Alt:V Core — ядро реального времени**
- Запускается как обычный сервер Alt:V.
- Отвечает за **игровую логику**: начисление денег, вызов такси, выполнение заданий, обновление статуса игрока.
- **Не подключается напрямую к интернету** — только к API через HTTP/WebSocket.
- Не хранит данные — только отправляет события и получает ответы.
- **Главное правило:** чем меньше кода в Alt:V — тем стабильнее сервер.

### 2. **Микросервисы в Docker — внешние интеграции**
Все внешние функции реализованы как независимые Node.js-приложения, упакованные в Docker-контейнеры:

| Сервис | Роль |
|--------|------|
| `auth-service` | Выдача и проверка JWT-токенов. Авторизация игроков по ID Alt:V. |
| `bank-service` | Управление балансами, переводами, историей операций. Получает запросы от ресурса банка в Alt:V. |
| `taxi-service` | Обработка вызовов такси, расчёт стоимости, фиксация оплаты, история поездок. |
| `donate-service` | Приём донатов через Stripe/PayPal. Автоматическое начисление бонусов. Использует очередь RabbitMQ для надёжной обработки. |
| `register-service` | Регистрация новых игроков через сайт. Привязка Discord/Steam к профилю. |
| `stats-service` | Сбор статистики: онлайн, активность, доходы. Данные отдаются на сайт и в Discord. |
| `notification-service` | Отправка уведомлений в Discord, Telegram, email при донатах, входах, изменениях баланса. |

> Все сервисы используют **одну базу данных** — это гарантирует целостность данных.

### 3. **API-шлюз — Nginx/Traefik**
- Единая точка входа для **всех** внешних запросов: сайт, ланчер, Discord-бот, ресурсы Alt:V.
- Маршрутизирует запросы к нужному микросервису (`/api/bank`, `/api/donate`, и т.д.).
- Обеспечивает:
  - HTTPS (SSL-сертификаты)
  - Ограничение частоты запросов (rate limiting)
  - CORS-политики
  - Балансировку нагрузки (если нужно масштабировать сервисы)

### 4. **База данных — PostgreSQL + Redis**
- **PostgreSQL** — основная хранилище данных: профили игроков, транзакции, истории, настройки.
- **Redis** — кэш и временные данные:
  - Кэширует балансы, роли, настройки — чтобы не грузить PostgreSQL при каждом запросе.
  - Хранит сессии JWT.
  - Используется как брокер сообщений для RabbitMQ.

### 5. **Авторизация — JWT**
- Игрок авторизуется один раз через `auth-service`.
- Сервер Alt:V получает JWT-токен и передаёт его при каждом запросе к API.
- Все микросервисы проверяют токен — не нужны сессии, куки, базы пользователей в каждом сервисе.
- Токены имеют короткий срок жизни и обновляются через refresh-токены.

### 6. **Мониторинг — Prometheus + Grafana + Sentry**
- **Prometheus** собирает метрики: количество запросов, время ответа, использование памяти.
- **Grafana** — красивый дашборд для админов: кто онлайн, сколько донатов, загрузка серверов.
- **Sentry** — ловит все ошибки в микросервисах: неправильные токены, проблемы с БД, сетевые сбои.
- Позволяет быстро находить и исправлять проблемы до того, как игроки их заметят.

---

## 📁 Структура проекта
altv-server-project/
├── server/                          # 🔧 Alt:V игровой сервер (не трогать после настройки)
│   ├── core/
│   │   └── server.js                # Главный скрипт Alt:V (запуск сервера)
│   └── resources/
│       ├── bank/                    # 🏦 Ресурс банка (взаимодействует с /api/bank)
│       │   ├── client.js            # Клиентская часть (для игрока)
│       │   └── server.js            # Серверная часть (на Alt:V)
│       ├── taxi/                    # 🚖 Ресурс такси
│       │   ├── client.js
│       │   └── server.js
│       ├── jobs/                    # 💼 Ресурс работы/заданий
│       │   ├── client.js
│       │   └── server.js
│       └── stats/                   # 📊 Ресурс сбора статистики
│           ├── client.js
│           └── server.js
│
├── api/                             # ⚙️ Микросервисы (Node.js + Express)
│   ├── auth-service/                # 🔐 Авторизация (JWT)
│   │   ├── index.js                 # Точка входа
│   │   ├── routes/
│   │   │   └── auth.js
│   │   ├── controllers/
│   │   │   └── authController.js
│   │   ├── models/
│   │   │   └── User.js
│   │   └── utils/
│   │       └── jwt.js
│   │
│   ├── bank-service/                # 🏦 Банковский сервис
│   │   ├── index.js
│   │   ├── routes/
│   │   │   └── bank.js
│   │   └── controllers/
│   │       └── bankController.js
│   │
│   ├── taxi-service/                # 🚖 Такси-сервис
│   │   ├── index.js
│   │   ├── routes/
│   │   │   └── taxi.js
│   │   └── controllers/
│   │       └── taxiController.js
│   │
│   ├── donate-service/              # 💸 Донаты (Stripe/PayPal)
│   │   ├── index.js
│   │   ├── routes/
│   │   │   └── donate.js
│   │   ├── queue-consumer.js        # Обработчик RabbitMQ
│   │   └── webhooks/
│   │       └── stripe.js
│   │
│   ├── register-service/            # 📝 Регистрация через сайт
│   │   ├── index.js
│   │   ├── routes/
│   │   │   └── register.js
│   │   └── steamAuth.js             # Привязка Steam-аккаунта
│   │
│   ├── stats-service/               # 📈 Сбор статистики
│   │   ├── index.js
│   │   ├── routes/
│   │   │   └── stats.js
│   │   └── collector.js             # Фоновый сбор данных из Alt:V
│   │
│   ├── notification-service/        # 📬 Уведомления (Discord/Telegram)
│   │   ├── index.js
│   │   └── discordNotifier.js
│   │
│   ├── .env.example                 # Шаблон переменных окружения (обязательно!)
│   ├── package.json                 # Общие зависимости для всех сервисов
│   └── Dockerfile                   # Общий Dockerfile для микросервисов (если используется один образ)
│
├── gateway/                         # 🌐 API Gateway (Nginx/Traefik)
│   └── nginx.conf                   # Конфиг Nginx: маршруты, SSL, rate limits, CORS
│
├── database/                        # 🗃️ База данных
│   ├── schema.sql                   # SQL-скрипты создания таблиц (PostgreSQL)
│   └── migrations/                  # По желанию — миграции (если используете Knex или Sequelize)
│       └── 001_initial_tables.sql
│
├── queues/                          # 📦 RabbitMQ
│   └── setup.js                     # Настройка очередей и обменников (RabbitMQ)
│
├── monitoring/                      # 📊 Мониторинг
│   ├── prometheus/
│   │   └── prometheus.yml           # Конфиг Prometheus для сбора метрик
│   └── grafana/
│       └── dashboards/
│           └── altv-server.json     # Экспорт дашборда Grafana (можно импортировать)
│
├── website/                         # 🌐 Веб-сайт / ланчер
│   ├── index.html                   # Главная страница
│   ├── app.js                       # Логика сайта (JS)
│   ├── styles.css                   # Стили
│   └── assets/                      # Изображения, иконки
│       ├── logo.png
│       └── favicon.ico
│
├── docker/                          # 🐳 Docker-образы
│   ├── altv/Dockerfile              # Образ Alt:V (если запускаете через Docker)
│   ├── api/Dockerfile               # Образ для микросервисов (Node.js)
│   └── gateway/Dockerfile           # Образ Nginx
│
├── docker-compose.yml               # 🚀 Главный файл запуска всего стека
│                                    # (Alt:V, API, DB, Redis, RabbitMQ, Nginx, Grafana, Prometheus)
│
├── scripts/                         # 🛠️ Полезные скрипты
│   ├── deploy.sh                    # Запуск всего стека (docker-compose up --build)
│   ├── start-all.sh                 # Локальный запуск (без Docker, для разработки)
│   ├── backup-db.sh                 # Бэкап PostgreSQL
│   └── restart-services.sh          # Перезапуск только API-сервисов
│
├── .env.example                     # 🔑 Шаблон переменных окружения (обязательно!)
├── .gitignore                       # 🔒 Что игнорировать (node_modules, .env, logs)
├── README.md                        # 📄 Главный файл проекта
└── LICENSE                          # 📜 Лицензия (MIT)

---

## ▶️ Как запустить

1. **Скопируйте `.env.example` → `.env`** и настройте переменные (DB_URL, JWT_SECRET, STRIPE_KEY и т.д.)
2. **Запустите весь стек одной командой:**
   ```bash
   docker-compose up --build
Это запустит: Alt:V, все микросервисы, PostgreSQL, Redis, RabbitMQ, Nginx, Prometheus, Grafana. 

Скопируйте игровые ресурсы (server/resources/) в папку resources вашего Alt:V-сервера.
Настройте Alt:V на подключение к API — используйте URL шлюза: https://yourdomain.com/api
Откройте сайт: http://yourdomain.com
Запустите бота: node discord-bot/bot.js
